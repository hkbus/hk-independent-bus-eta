import{g as oe,r as $,ab as ue,a8 as se,a6 as ce,a7 as le,bf as fe,ap as Q,bn as he,j as S,ac as te,ae as re}from"./index-C1QwAi2s.js";import{C as me}from"./TimeReport-BIY0biUf.js";import{u as de,a5 as ge,a6 as pe}from"./App-DZK4CLd6.js";import{S as ve}from"./Snackbar-DDHwttmA.js";import"./CircularProgress-CvupeoU8.js";var ie={exports:{}};(function(b){(function(h){var a=D(),y=W(),B=q(),G=Y(),M={imagePlaceholder:void 0,cacheBust:!1},d={toSvg:k,toPng:v,toJpeg:P,toBlob:E,toPixelData:p,impl:{fontFaces:B,images:G,util:a,inliner:y,options:{}}};b.exports=d;function k(n,e){return e=e||{},H(e),Promise.resolve(n).then(function(i){return V(i,e.filter,!0)}).then(z).then(_).then(r).then(function(i){return J(i,e.width||a.width(n),e.height||a.height(n))});function r(i){return e.bgcolor&&(i.style.backgroundColor=e.bgcolor),e.width&&(i.style.width=e.width+"px"),e.height&&(i.style.height=e.height+"px"),e.style&&Object.keys(e.style).forEach(function(l){i.style[l]=e.style[l]}),i}}function p(n,e){return N(n,e||{}).then(function(r){return r.getContext("2d").getImageData(0,0,a.width(n),a.height(n)).data})}function v(n,e){return N(n,e||{}).then(function(r){return r.toDataURL()})}function P(n,e){return e=e||{},N(n,e).then(function(r){return r.toDataURL("image/jpeg",e.quality||1)})}function E(n,e){return N(n,e||{}).then(a.canvasToBlob)}function H(n){typeof n.imagePlaceholder>"u"?d.impl.options.imagePlaceholder=M.imagePlaceholder:d.impl.options.imagePlaceholder=n.imagePlaceholder,typeof n.cacheBust>"u"?d.impl.options.cacheBust=M.cacheBust:d.impl.options.cacheBust=n.cacheBust}function N(n,e){return k(n,e).then(a.makeImage).then(a.delay(100)).then(function(i){var l=r(n);return l.getContext("2d").drawImage(i,0,0),l});function r(i){var l=document.createElement("canvas");if(l.width=e.width||a.width(i),l.height=e.height||a.height(i),e.bgcolor){var c=l.getContext("2d");c.fillStyle=e.bgcolor,c.fillRect(0,0,l.width,l.height)}return l}}function V(n,e,r){if(!r&&e&&!e(n))return Promise.resolve();return Promise.resolve(n).then(i).then(function(o){return l(n,o,e)}).then(function(o){return c(n,o)});function i(o){return o instanceof HTMLCanvasElement?a.makeImage(o.toDataURL()):o.cloneNode(!1)}function l(o,u,C){var I=o.childNodes;if(I.length===0)return Promise.resolve(u);return g(u,a.asArray(I),C).then(function(){return u});function g(X,A,w){var T=Promise.resolve();return A.forEach(function(F){T=T.then(function(){return V(F,w)}).then(function(j){j&&X.appendChild(j)})}),T}}function c(o,u){if(!(u instanceof Element))return u;return Promise.resolve().then(C).then(I).then(g).then(X).then(function(){return u});function C(){A(window.getComputedStyle(o),u.style);function A(w,T){w.cssText?T.cssText=w.cssText:F(w,T);function F(j,L){a.asArray(j).forEach(function(t){L.setProperty(t,j.getPropertyValue(t),j.getPropertyPriority(t))})}}}function I(){[":before",":after"].forEach(function(w){A(w)});function A(w){var T=window.getComputedStyle(o,w),F=T.getPropertyValue("content");if(F===""||F==="none")return;var j=a.uid();u.className=u.className+" "+j;var L=document.createElement("style");L.appendChild(t(j,w,T)),u.appendChild(L);function t(s,m,f){var x="."+s+":"+m,U=f.cssText?Z(f):ee(f);return document.createTextNode(x+"{"+U+"}");function Z(O){var R=O.getPropertyValue("content");return O.cssText+" content: "+R+";"}function ee(O){return a.asArray(O).map(R).join("; ")+";";function R(K){return K+": "+O.getPropertyValue(K)+(O.getPropertyPriority(K)?" !important":"")}}}}}function g(){o instanceof HTMLTextAreaElement&&(u.innerHTML=o.value),o instanceof HTMLInputElement&&u.setAttribute("value",o.value)}function X(){u instanceof SVGElement&&(u.setAttribute("xmlns","http://www.w3.org/2000/svg"),u instanceof SVGRectElement&&["width","height"].forEach(function(A){var w=u.getAttribute(A);w&&u.style.setProperty(A,w)}))}}}function z(n){return B.resolveAll().then(function(e){var r=document.createElement("style");return n.appendChild(r),r.appendChild(document.createTextNode(e)),n})}function _(n){return G.inlineAll(n).then(function(){return n})}function J(n,e,r){return Promise.resolve(n).then(function(i){return i.setAttribute("xmlns","http://www.w3.org/1999/xhtml"),new XMLSerializer().serializeToString(i)}).then(a.escapeXhtml).then(function(i){return'<foreignObject x="0" y="0" width="100%" height="100%">'+i+"</foreignObject>"}).then(function(i){return'<svg xmlns="http://www.w3.org/2000/svg" width="'+e+'" height="'+r+'">'+i+"</svg>"}).then(function(i){return"data:image/svg+xml;charset=utf-8,"+i})}function D(){return{escape:X,parseExtension:e,mimeType:r,dataAsUrl:g,isDataUrl:i,canvasToBlob:c,resolveUrl:o,getAndEncode:I,uid:u(),delay:A,asArray:w,escapeXhtml:T,makeImage:C,width:F,height:j};function n(){var t="application/font-woff",s="image/jpeg";return{woff:t,woff2:t,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:s,jpeg:s,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}function e(t){var s=/\.([^\.\/]*?)$/g.exec(t);return s?s[1]:""}function r(t){var s=e(t).toLowerCase();return n()[s]||""}function i(t){return t.search(/^(data:)/)!==-1}function l(t){return new Promise(function(s){for(var m=window.atob(t.toDataURL().split(",")[1]),f=m.length,x=new Uint8Array(f),U=0;U<f;U++)x[U]=m.charCodeAt(U);s(new Blob([x],{type:"image/png"}))})}function c(t){return t.toBlob?new Promise(function(s){t.toBlob(s)}):l(t)}function o(t,s){var m=document.implementation.createHTMLDocument(),f=m.createElement("base");m.head.appendChild(f);var x=m.createElement("a");return m.body.appendChild(x),f.href=s,x.href=t,x.href}function u(){var t=0;return function(){return"u"+s()+t++;function s(){return("0000"+(Math.random()*Math.pow(36,4)<<0).toString(36)).slice(-4)}}}function C(t){return new Promise(function(s,m){var f=new Image;f.onload=function(){s(f)},f.onerror=m,f.src=t})}function I(t){var s=3e4;return d.impl.options.cacheBust&&(t+=(/\?/.test(t)?"&":"?")+new Date().getTime()),new Promise(function(m){var f=new XMLHttpRequest;f.onreadystatechange=Z,f.ontimeout=ee,f.responseType="blob",f.timeout=s,f.open("GET",t,!0),f.send();var x;if(d.impl.options.imagePlaceholder){var U=d.impl.options.imagePlaceholder.split(/,/);U&&U[1]&&(x=U[1])}function Z(){if(f.readyState===4){if(f.status!==200){x?m(x):O("cannot fetch resource: "+t+", status: "+f.status);return}var R=new FileReader;R.onloadend=function(){var K=R.result.split(/,/)[1];m(K)},R.readAsDataURL(f.response)}}function ee(){x?m(x):O("timeout of "+s+"ms occured while fetching resource: "+t)}function O(R){console.error(R),m("")}})}function g(t,s){return"data:"+s+";base64,"+t}function X(t){return t.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}function A(t){return function(s){return new Promise(function(m){setTimeout(function(){m(s)},t)})}}function w(t){for(var s=[],m=t.length,f=0;f<m;f++)s.push(t[f]);return s}function T(t){return t.replace(/#/g,"%23").replace(/\n/g,"%0A")}function F(t){var s=L(t,"border-left-width"),m=L(t,"border-right-width");return t.scrollWidth+s+m}function j(t){var s=L(t,"border-top-width"),m=L(t,"border-bottom-width");return t.scrollHeight+s+m}function L(t,s){var m=window.getComputedStyle(t).getPropertyValue(s);return parseFloat(m.replace("px",""))}}function W(){var n=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:l,shouldProcess:e,impl:{readUrls:r,inline:i}};function e(c){return c.search(n)!==-1}function r(c){for(var o=[],u;(u=n.exec(c))!==null;)o.push(u[1]);return o.filter(function(C){return!a.isDataUrl(C)})}function i(c,o,u,C){return Promise.resolve(o).then(function(g){return u?a.resolveUrl(g,u):g}).then(C||a.getAndEncode).then(function(g){return a.dataAsUrl(g,a.mimeType(o))}).then(function(g){return c.replace(I(o),"$1"+g+"$3")});function I(g){return new RegExp(`(url\\(['"]?)(`+a.escape(g)+`)(['"]?\\))`,"g")}}function l(c,o,u){if(C())return Promise.resolve(c);return Promise.resolve(c).then(r).then(function(I){var g=Promise.resolve(c);return I.forEach(function(X){g=g.then(function(A){return i(A,X,o,u)})}),g});function C(){return!e(c)}}}function q(){return{resolveAll:n,impl:{readAll:e}};function n(){return e().then(function(r){return Promise.all(r.map(function(i){return i.resolve()}))}).then(function(r){return r.join(`
`)})}function e(){return Promise.resolve(a.asArray(document.styleSheets)).then(i).then(r).then(function(c){return c.map(l)});function r(c){return c.filter(function(o){return o.type===CSSRule.FONT_FACE_RULE}).filter(function(o){return y.shouldProcess(o.style.getPropertyValue("src"))})}function i(c){var o=[];return c.forEach(function(u){try{a.asArray(u.cssRules||[]).forEach(o.push.bind(o))}catch(C){console.log("Error while reading CSS rules from "+u.href,C.toString())}}),o}function l(c){return{resolve:function(){var u=(c.parentStyleSheet||{}).href;return y.inlineAll(c.cssText,u)},src:function(){return c.style.getPropertyValue("src")}}}}}function Y(){return{inlineAll:e,impl:{newImage:n}};function n(r){return{inline:i};function i(l){return a.isDataUrl(r.src)?Promise.resolve():Promise.resolve(r.src).then(l||a.getAndEncode).then(function(c){return a.dataAsUrl(c,a.mimeType(r.src))}).then(function(c){return new Promise(function(o,u){r.onload=o,r.onerror=u,r.src=c})})}}function e(r){if(!(r instanceof Element))return Promise.resolve(r);return i(r).then(function(){return r instanceof HTMLImageElement?n(r).inline():Promise.all(a.asArray(r.childNodes).map(function(l){return e(l)}))});function i(l){var c=l.style.getPropertyValue("background");return c?y.inlineAll(c).then(function(o){l.style.setProperty("background",o,l.style.getPropertyPriority("background"))}).then(function(){return l}):Promise.resolve(l)}}}})()})(ie);var ye=ie.exports;const we=oe(ye);var xe={format:"image/png",quality:.92,width:void 0,height:void 0,Canvas:void 0,crossOrigin:void 0},be=function(b,h){return b===void 0&&(b=[]),h===void 0&&(h={}),new Promise(function(a){h=Object.assign({},xe,h);var y=h.Canvas?new h.Canvas:window.document.createElement("canvas"),B=h.Image||window.Image,G=b.map(function(d){return new Promise(function(k,p){d.constructor.name!=="Object"&&(d={src:d});var v=new B;v.crossOrigin=h.crossOrigin,v.onerror=function(){return p(new Error("Couldn't load image"))},v.onload=function(){return k(Object.assign({},d,{img:v}))},v.src=d.src})}),M=y.getContext("2d");a(Promise.all(G).then(function(d){var k=function(p){return h[p]||Math.max.apply(Math,d.map(function(v){return v.img[p]}))};return y.width=k("width"),y.height=k("height"),d.forEach(function(p){return M.globalAlpha=p.opacity?p.opacity:1,M.drawImage(p.img,p.x||0,p.y||0)}),h.Canvas&&h.format==="image/jpeg"?new Promise(function(p,v){y.toDataURL(h.format,{quality:h.quality,progressive:!1},function(P,E){if(P){v(P);return}p(E)})}):y.toDataURL(h.format,h.quality)}))})};const ke=({routeId:b,seq:h=-1,stopId:a,event:y})=>{const[{isOpen:B,isCopied:G},M]=$.useState(Pe),{AppTitle:d,db:{routeList:k,stopList:p}}=$.useContext(ue),{colorMode:v}=$.useContext(se),{t:P}=ce(),E=le(),[H,N]=$.useState(""),{id:V}=de(),{route:z,dest:_}=k[b],J=p[a],D=$.useCallback(n=>M(e=>({...e,isOpen:n})),[]),W=$.useCallback(n=>M(e=>({...e,isCopied:n})),[]);$.useEffect(()=>{y&&D(!0)},[D,y]);const q=$.useCallback(()=>{fe(`https://${window.location.hostname}/${E}/route/${V}/${a}%2C${h}`,`${h+1}. ${Q(J.name[E])} - ${z} ${P("往")} ${Q(_[E])} - ${P(d)}`).then(()=>{navigator.clipboard&&W(!0)}).finally(()=>{D(!1)})},[d,V,_,P,W,E,h,J.name,a,z,D]);$.useEffect(()=>{if(B&&window.harmonyShare){q();return}return B&&Promise.all([ne("route-eta-header",v),ne("route-map",v),ne(`stop-${h}`,v)]).then(n=>{let e=0;return be(n.filter(([r])=>r).map(([r,i])=>(e+=i,{src:r,x:0,y:e-i})),{height:e})}).then(n=>{N(n)}),()=>{N("")}},[B,v,h,q]);const Y=$.useCallback(()=>{he(H,`https://${window.location.hostname}/${E}/route/${V}/${a}%2C${h}`,`${h+1}. ${Q(J.name[E])} - ${z} ${P("往")} ${Q(_[E])} - https://hkbus.app/`).then(()=>{navigator.clipboard&&W(!0)}).finally(()=>{D(!1)})},[_,W,D,J.name,a,P,H,E,V,h,z]);return S.jsxs(S.Fragment,{children:[S.jsx(ge,{sx:Ce,onClose:()=>D(!1),open:B,children:S.jsx(pe,{maxWidth:"xs",sx:Ee,fixed:!0,children:S.jsxs(te,{sx:Ae,children:[S.jsx(te,{sx:Se,children:H?S.jsx("img",{src:H,style:{objectFit:"contain",width:396,height:400},alt:""}):S.jsx(me,{color:"inherit"})}),S.jsxs(te,{sx:Te,children:[S.jsx(re,{sx:ae,onClick:q,children:P("以鏈結分享")}),S.jsx(re,{sx:ae,onClick:Y,disabled:H==="",children:P("以圖片分享")})]})]})})}),S.jsx(ve,{anchorOrigin:{vertical:"bottom",horizontal:"center"},open:G,autoHideDuration:1500,onClose:()=>{W(!1)},message:P("已複製到剪貼簿")})]})},ne=(b,h)=>{const a=document.getElementById(b);return a?we.toPng(a,{bgcolor:h==="light"?"#fedb00":"#000"}).then(y=>[y,a.clientHeight,a.clientWidth]):Promise.resolve(["",0,0])},Pe={isOpen:!1,isCopied:!1},Ce={display:"flex",alignItems:"center"},Ee={display:"flex",justifyContent:"center",outline:"none"},Ae={display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flex:1,background:b=>b.palette.background.default},Se={display:"flex",alignItems:"center",justifyContent:"center",height:400,width:"100%"},Te={display:"flex",width:"100%",backgroundColor:b=>b.palette.background.default},ae={flex:1,border:"1px solid rgba(255, 255, 255, 0.3)"};export{ke as default};
